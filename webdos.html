<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>DOS with ZIP Mount</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body {
    background: black;
    color: lime;
    font-family: monospace;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  #output {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    white-space: pre-wrap;
    word-break: break-word;
  }
  #input {
    border: none;
    padding: 15px;
    width: 100%;
    background: black;
    color: lime;
    font-family: monospace;
    font-size: 20px;
    box-sizing: border-box;
    outline: none;
    position: sticky;
    bottom: 0;
    border-top: 1px solid lime;
  }
  #fileInput {
    position: fixed;
    top: 10px;
    right: 10px;
    z-index: 100;
    background: #222;
    color: lime;
    border: 1px solid lime;
    padding: 5px;
    font-family: monospace;
  }
</style>
</head>
<body>

<input type="file" id="fileInput" />
<div id="output">Microsoft DOS [Version 1.0]<br>A:\></div>
<input id="input" autofocus autocomplete="off" spellcheck="false" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
class DOS {
  constructor(outputElement) {
    this.fs = {
      'A:\\': { type: 'dir', children: {} }
    };
    this.cwd = 'A:\\';
    this.output = outputElement;
  }

  async mountZip(zipFile, mountPoint = 'A:\\ZIP_MOUNT\\') {
    const out = (text = '') => this.output.innerHTML += text + '<br>';
    out(`Mounting ZIP file at ${mountPoint}`);

    // Ensure mount point exists
    const root = this._getDir('A:\\');
    if (!root.children['ZIP_MOUNT']) {
      root.children['ZIP_MOUNT'] = { type: 'dir', children: {} };
    }

    try {
      const zip = await JSZip.loadAsync(zipFile);
      const mountDir = root.children['ZIP_MOUNT'];
      // Clear previous mount
      mountDir.children = {};

      // Recursively add zip files/folders into mountDir.children
      Object.keys(zip.files).forEach(filename => {
        const file = zip.files[filename];
        const parts = filename.split('/').filter(p => p.length > 0);
        let current = mountDir;

        parts.forEach((part, idx) => {
          const isFile = (idx === parts.length - 1) && !file.dir;
          if (isFile) {
            // Add file entry with lazy loading content
            current.children[part] = {
              type: 'file',
              get content() {
                // Lazy content read on demand (simplified here)
                return '(Binary file content)';
              },
              _zipFile: file
            };
          } else {
            // Directory
            if (!current.children[part]) {
              current.children[part] = { type: 'dir', children: {} };
            }
            current = current.children[part];
          }
        });
      });
      out(`ZIP mounted successfully.`);
    } catch(e) {
      out(`Error mounting ZIP: ${e.message}`);
    }
  }

  run(commandLine) {
    const [cmd, ...args] = commandLine.trim().split(/\s+/);
    const out = (text = '') => this.output.innerHTML += text + '<br>';
    const command = cmd.toLowerCase();

    switch(command) {
      case 'dir': {
        const dir = this._getDir(this.cwd);
        if (dir && dir.children) {
          if (Object.keys(dir.children).length === 0) {
            out(' Volume in drive A is DOS_EMULATOR');
            out(' Directory of ' + this.cwd);
            out('');
            out(' 0 File(s)              0 bytes');
            out(' 0 Dir(s)');
          } else {
            Object.keys(dir.children).forEach(name => {
              const item = dir.children[name];
              out(`${item.type === 'dir' ? '<DIR>' : '     '} ${name}`);
            });
          }
        } else {
          out('Invalid directory');
        }
        break;
      }
      case 'cd': {
        if (!args[0]) return out('Usage: cd [dirname]');
        const path = this._resolvePath(args[0]);
        const dirTarget = this._getDir(path);
        if (dirTarget) {
          this.cwd = path;
        } else {
          out('Directory not found');
        }
        break;
      }
      case 'type': {
        if (!args[0]) return out('Usage: type [filename]');
        const file = this._getDir(this.cwd).children[args[0]];
        if (file && file.type === 'file') {
          // If from zip, try to read content asynchronously
          if (file._zipFile) {
            file._zipFile.async('string').then(content => {
              out(content);
              printPrompt();
            });
          } else {
            out(file.content || '');
          }
        } else {
          out('File not found');
        }
        break;
      }
      case 'help':
        out('Commands: dir, cd, type, help');
        break;
      default:
        out(`Unknown command: ${cmd}`);
    }
  }

  _getDir(path) {
    if (!path.startsWith('A:\\')) return null;
    const parts = path.replace(/\\$/, '').split('\\').filter(Boolean);
    let current = this.fs['A:\\'];
    for (let i = 1; i < parts.length; i++) {
      const part = parts[i];
      if (!current.children[part] || current.children[part].type !== 'dir') {
        return null;
      }
      current = current.children[part];
    }
    return current;
  }

  _resolvePath(input) {
    if (input.startsWith('A:\\')) return input.endsWith('\\') ? input : input + '\\';
    if (input === '..') {
      const parts = this.cwd.split('\\').filter(Boolean);
      if (parts.length > 1) parts.pop();
      return parts.length > 0 ? parts.join('\\') + '\\' : 'A:\\';
    }
    if (input === '.') {
      return this.cwd;
    }
    return this.cwd + input + '\\';
  }
}

const output = document.getElementById('output');
const input = document.getElementById('input');
const dos = new DOS(output);

function printPrompt() {
  output.innerHTML += dos.cwd + '>';
  scrollToBottom();
}

function scrollToBottom() {
  output.scrollTop = output.scrollHeight;
}

input.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    const cmd = input.value.trim();
    if (cmd) {
      output.innerHTML += cmd + '<br>';
      dos.run(cmd);
    }
    printPrompt();
    input.value = '';
    scrollToBottom();
  }
});

// Focus input on tap
document.body.addEventListener('click', () => {
  input.focus();
});

// Handle file upload and mount ZIP
document.getElementById('fileInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  if (file.name.toLowerCase().endsWith('.zip')) {
    await dos.mountZip(file);
    printPrompt();
  } else {
    output.innerHTML += `Only ZIP files supported currently.<br>`;
    printPrompt();
  }
});

printPrompt();
</script>
</body>
</html>
