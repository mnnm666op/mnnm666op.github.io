<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Universal Media Player</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f9f9f9; }
    input[type="file"], input[type="text"], button, select {
      margin: 0.5rem 0; padding: 0.5rem; width: 100%;
    }
    audio, video { display: block; margin: 1rem 0; max-width: 100%; }
    .preview { margin-top: 1rem; }
    pre { background: #eee; padding: 1rem; overflow: auto; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://unpkg.com/music-metadata-browser/dist/music-metadata-browser.umd.js"></script>
</head>
<body>
  <h1>Universal Media Player</h1>

  <input type="file" id="fileInput" multiple accept="audio/*,video/*,.zip">
  <input type="text" id="youtubeInput" placeholder="YouTube Video URL">
  <button id="embedYouTube">Embed YouTube</button>
  <input type="text" id="soundcloudInput" placeholder="SoundCloud Track URL">
  <button id="embedSoundCloud">Embed SoundCloud</button>
  <div id="preview" class="preview"></div>

  <h2>Upload to GitHub</h2>
  <input type="text" id="tokenInput" placeholder="GitHub Personal Access Token">
  <input type="text" id="repoInput" placeholder="username/repo">
  <input type="text" id="pathPrefix" placeholder="Path prefix (e.g., media/)" value="media/">
  <button id="uploadBtn">Upload Media Files</button>
  <pre id="uploadStatus"></pre>

  <script>
    const fileInput = document.getElementById("fileInput");
    const preview = document.getElementById("preview");
    const embedYouTubeBtn = document.getElementById("embedYouTube");
    const embedSoundCloudBtn = document.getElementById("embedSoundCloud");
    const uploadBtn = document.getElementById("uploadBtn");
    const uploadStatus = document.getElementById("uploadStatus");

    let mediaFiles = [];

    function createMediaElement(type, url) {
      if (type.startsWith("audio")) {
        const audio = document.createElement("audio");
        audio.controls = true;
        audio.src = url;
        return audio;
      } else if (type.startsWith("video")) {
        const video = document.createElement("video");
        video.controls = true;
        video.src = url;
        return video;
      }
      return null;
    }

    async function extractArtist(file) {
      try {
        const arrayBuffer = await file.arrayBuffer();
        const metadata = await musicMetadata.parseBuffer(Buffer.from(arrayBuffer), file.type);
        return metadata.common.artist || "Unknown Artist";
      } catch (e) {
        return "Unknown Artist";
      }
    }

    fileInput.addEventListener("change", async () => {
      preview.innerHTML = "";
      mediaFiles = [];

      for (const f of fileInput.files) {
        if (f.name.endsWith(".zip")) {
          const zip = await JSZip.loadAsync(f);
          for (const entry of Object.values(zip.files)) {
            if (!entry.dir) {
              const blob = await entry.async("blob");
              const type = blob.type || (entry.name.endsWith(".mp3") ? "audio/mpeg" : "application/octet-stream");
              const url = URL.createObjectURL(blob);
              const fileObj = new File([blob], entry.name, { type });
              const artist = await extractArtist(fileObj);
              mediaFiles.push({ name: entry.name, url, type, file: fileObj, artist });

              const el = createMediaElement(type, url);
              if (el) preview.appendChild(el);
            }
          }
        } else {
          const url = URL.createObjectURL(f);
          const artist = await extractArtist(f);
          mediaFiles.push({ name: f.name, url, type: f.type, file: f, artist });

          const el = createMediaElement(f.type, url);
          if (el) preview.appendChild(el);
        }
      }
    });

    embedYouTubeBtn.addEventListener("click", () => {
      const url = document.getElementById("youtubeInput").value.trim();
      const match = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/);
      if (match) {
        const iframe = document.createElement("iframe");
        iframe.width = "560";
        iframe.height = "315";
        iframe.src = `https://www.youtube.com/embed/${match[1]}`;
        iframe.allow = "autoplay; encrypted-media";
        iframe.allowFullscreen = true;
        preview.appendChild(iframe);
      }
    });

    embedSoundCloudBtn.addEventListener("click", () => {
      const url = document.getElementById("soundcloudInput").value.trim();
      if (url) {
        const iframe = document.createElement("iframe");
        iframe.width = "100%";
        iframe.height = "166";
        iframe.scrolling = "no";
        iframe.frameBorder = "no";
        iframe.allow = "autoplay";
        iframe.src = `https://w.soundcloud.com/player/?url=${encodeURIComponent(url)}&auto_play=false`;
        preview.appendChild(iframe);
      }
    });

    uploadBtn.addEventListener("click", async () => {
      const token = document.getElementById("tokenInput").value.trim();
      const repo = document.getElementById("repoInput").value.trim();
      const prefix = document.getElementById("pathPrefix").value.trim().replace(/^\/|\/$/g, "") + "/";

      if (!token || !repo) {
        alert("Please enter both GitHub token and repo.");
        return;
      }

      uploadStatus.textContent = "Uploading...\n";

      for (const fileObj of mediaFiles) {
        const file = fileObj.file;
        const artistFolder = (fileObj.artist || "Unknown Artist").replace(/[\\/:*?"<>|]/g, "_");
        const fullPath = `${prefix}${artistFolder}/${file.name}`;

        const content = await file.arrayBuffer();
        const base64Content = btoa(String.fromCharCode(...new Uint8Array(content)));

        const url = `https://api.github.com/repos/${repo}/contents/${fullPath}`;
        const res = await fetch(url, {
          method: "PUT",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: `Upload ${file.name}`,
            content: base64Content
          })
        });

        if (res.ok) {
          uploadStatus.textContent += `✅ Uploaded to: ${fullPath}\n`;
        } else {
          const error = await res.json();
          uploadStatus.textContent += `❌ Error uploading ${file.name}: ${error.message}\n`;
        }
      }

      uploadStatus.textContent += "Done!";
    });
  </script>
</body>
</html>
