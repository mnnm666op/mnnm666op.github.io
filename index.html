<script>
  // Helper functions for cookies
  function setCookie(name, value, days = 7) {
    const expires = new Date(Date.now() + days * 864e5).toUTCString();
    document.cookie = name + '=' + encodeURIComponent(value) + '; expires=' + expires + '; path=/';
  }

  function getCookie(name) {
    return document.cookie.split('; ').reduce((r, v) => {
      const parts = v.split('=');
      return parts[0] === name ? decodeURIComponent(parts[1]) : r;
    }, '');
  }

  // ZIP Playlist Player Code
  const zipInput = document.getElementById('zipInput');
  const playlistEl = document.getElementById('playlist');
  const videoPlayer = document.getElementById('videoPlayer');
  const audioPlayer = document.getElementById('audioPlayer');
  const nowPlaying = document.getElementById('nowPlaying');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  let mediaFiles = [];
  let currentIndex = -1;

  zipInput.addEventListener('change', async () => {
    const file = zipInput.files[0];
    if (!file) return;
    resetPlayers();
    mediaFiles = [];
    currentIndex = -1;
    updateButtons();
    updatePlaylist();
    hideEmbedPlayers();

    try {
      const zip = await JSZip.loadAsync(file);
      const entries = Object.values(zip.files).filter(f =>
        !f.dir && /\.(mp3|mp4|wav|webm|ogg)$/i.test(f.name)
      );
      for (const entry of entries) {
        const blob = await entry.async("blob");
        const url = URL.createObjectURL(blob);
        const type = /\.(mp4|webm)$/i.test(entry.name) ? "video" : "audio";
        mediaFiles.push({ name: entry.name, url, type });
      }
      mediaFiles.sort((a, b) => a.name.localeCompare(b.name));
      if (mediaFiles.length) {
        const savedIndex = parseInt(getCookie('zipIndex') || '0', 10);
        playMedia(savedIndex >= 0 && savedIndex < mediaFiles.length ? savedIndex : 0);
      } else {
        nowPlaying.textContent = "No supported media files found in ZIP.";
      }
    } catch (e) {
      nowPlaying.textContent = "Error reading ZIP file.";
      console.error(e);
    }
  });

  function updatePlaylist() {
    playlistEl.innerHTML = "";
    mediaFiles.forEach((file, i) => {
      const li = document.createElement("li");
      li.textContent = file.name;
      li.classList.toggle("active", i === currentIndex);
      li.onclick = () => playMedia(i);
      playlistEl.appendChild(li);
    });
  }

  function playMedia(index) {
    if (index < 0 || index >= mediaFiles.length) return;
    currentIndex = index;
    setCookie('zipIndex', currentIndex);
    const file = mediaFiles[index];
    nowPlaying.textContent = `Now Playing: ${file.name}`;
    videoPlayer.pause();
    audioPlayer.pause();
    videoPlayer.style.display = "none";
    audioPlayer.style.display = "none";
    hideEmbedPlayers();
    if (file.type === "video") {
      videoPlayer.src = file.url;
      videoPlayer.style.display = "block";
      videoPlayer.play();
      videoPlayer.onended = playNext;
    } else {
      audioPlayer.src = file.url;
      audioPlayer.style.display = "block";
      audioPlayer.play();
      audioPlayer.onended = playNext;
    }
    updatePlaylist();
    updateButtons();
  }

  function playNext() {
    if (currentIndex + 1 < mediaFiles.length) {
      playMedia(currentIndex + 1);
    }
  }

  function playPrev() {
    if (currentIndex - 1 >= 0) {
      playMedia(currentIndex - 1);
    }
  }

  function updateButtons() {
    prevBtn.disabled = currentIndex <= 0;
    nextBtn.disabled = currentIndex === -1 || currentIndex >= mediaFiles.length - 1;
  }

  function resetPlayers() {
    videoPlayer.pause();
    audioPlayer.pause();
    videoPlayer.src = "";
    audioPlayer.src = "";
    videoPlayer.style.display = "none";
    audioPlayer.style.display = "none";
    nowPlaying.textContent = "No track loaded";
  }

  function hideEmbedPlayers() {
    scPlayer.style.display = "none";
    ytPlayer.style.display = "none";
  }

  prevBtn.addEventListener("click", playPrev);
  nextBtn.addEventListener("click", playNext);

  // SoundCloud Embed Player
  const scUrlInput = document.getElementById("scUrl");
  const scLoadBtn = document.getElementById("scLoadBtn");
  const scPlayer = document.getElementById("scPlayer");

  scLoadBtn.addEventListener("click", () => {
    const url = scUrlInput.value.trim();
    if (!url) return;
    setCookie("scUrl", url);
    resetPlayers();
    ytPlayer.style.display = "none";
    const embedUrl = `https://w.soundcloud.com/player/?url=${encodeURIComponent(url)}&color=%236a9ae2&auto_play=true&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=true`;
    scPlayer.src = embedUrl;
    scPlayer.style.height = "166px";
    scPlayer.style.display = "block";
    nowPlaying.textContent = `Playing SoundCloud content`;
    playlistEl.innerHTML = "";
    prevBtn.disabled = true;
    nextBtn.disabled = true;
  });

  // YouTube Embed Player
  const ytUrlInput = document.getElementById("ytUrl");
  const ytLoadBtn = document.getElementById("ytLoadBtn");
  const ytPlayer = document.getElementById("ytPlayer");

  ytLoadBtn.addEventListener("click", () => {
    const url = ytUrlInput.value.trim();
    if (!url) return;
    setCookie("ytUrl", url);
    resetPlayers();
    scPlayer.style.display = "none";
    let urlObj;
    try {
      urlObj = new URL(url);
    } catch {
      alert("Invalid YouTube URL");
      return;
    }
    const playlistId = urlObj.searchParams.get("list");
    if (playlistId) {
      const embedUrl = `https://www.youtube.com/embed/videoseries?list=${playlistId}&autoplay=1&controls=1`;
      ytPlayer.src = embedUrl;
      ytPlayer.style.display = "block";
      nowPlaying.textContent = "Playing YouTube playlist";
      playlistEl.innerHTML = "";
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      return;
    }
    const videoId = extractYouTubeID(url);
    if (!videoId) {
      alert("Invalid YouTube URL");
      return;
    }
    const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&controls=1`;
    ytPlayer.src = embedUrl;
    ytPlayer.style.display = "block";
    nowPlaying.textContent = "Playing YouTube video";
    playlistEl.innerHTML = "";
    prevBtn.disabled = true;
    nextBtn.disabled = true;
  });

  function extractYouTubeID(url) {
    try {
      const u = new URL(url);
      if (u.hostname === "youtu.be") return u.pathname.slice(1);
      if (u.hostname.includes("youtube.com")) return u.searchParams.get("v");
      return null;
    } catch {
      return null;
    }
  }

  // Auto-load cookies on page load
  window.addEventListener("DOMContentLoaded", () => {
    const savedScUrl = getCookie("scUrl");
    if (savedScUrl) {
      scUrlInput.value = savedScUrl;
      scLoadBtn.click();
    }
    const savedYtUrl = getCookie("ytUrl");
    if (savedYtUrl) {
      ytUrlInput.value = savedYtUrl;
      ytLoadBtn.click();
    }
  });
</script>
